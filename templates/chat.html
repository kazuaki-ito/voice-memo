<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Èü≥Â£∞„ÉÅ„É£„ÉÉ„Éà</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }
    h1 {
      text-align: center;
      padding: 10px;
      margin: 0;
      background-color: #3b82f6;
      color: white;
      font-size: 18px;
    }
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .user {
      align-self: flex-end;
      background-color: #3b82f6;
      color: white;
    }
    .ai {
      align-self: flex-start;
      background-color: #e0f7fa;
      color: black;
    }
    .controls {
      display: flex;
      justify-content: center;
      padding: env(safe-area-inset-bottom, 10px) 10px 10px;
      gap: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background-color: #3b82f6;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    audio {
      display: inline-block;
      width: 100%;
      max-width: 250px;
      margin-top: 5px;
    }
    .status {
      text-align: center;
      font-size: 14px;
      color: #666;
      padding: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Èü≥Â£∞„ÉÅ„É£„ÉÉ„Éà</h1>
    <div class="status" id="status"></div>
    <div class="chat" id="chatBox"></div>
    <div class="controls">
      <button id="startBtn">üéôÔ∏è Èå≤Èü≥</button>
      <button id="stopBtn" disabled>‚èπÔ∏è ÂÅúÊ≠¢ÔºÜÈÄÅ‰ø°</button>
    </div>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const chatBox = document.getElementById("chatBox");
    const statusBox = document.getElementById("status");

    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          statusBox.textContent = "‚è≥ ÈÄÅ‰ø°‰∏≠...";

          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append("file", blob, "voice.webm");

          const res = await fetch("/upload", { method: "POST", body: formData });
          const text = await res.text();

          try {
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}') + 1;
            const jsonStr = text.slice(jsonStart, jsonEnd);
            const json = JSON.parse(jsonStr);

            const userText = json.user_text || "";
            const reply = json.reply || "";

            const userTextMsg = document.createElement("div");
            userTextMsg.className = "message user";
            userTextMsg.textContent = userText;
            chatBox.appendChild(userTextMsg);

            const audioEl = document.createElement("audio");
            audioEl.setAttribute("controls", "");
            audioEl.setAttribute("preload", "auto");
            audioEl.setAttribute("style","width:300px;")
            audioEl.src = URL.createObjectURL(blob);
            const audioMsg = document.createElement("div");
            audioMsg.className = "message user";
            audioMsg.appendChild(audioEl);
            chatBox.appendChild(audioMsg);

            const aiMsg = document.createElement("div");
            aiMsg.className = "message ai";
            aiMsg.textContent = reply;
            chatBox.appendChild(aiMsg);

            const utterance = new SpeechSynthesisUtterance(reply);
            utterance.lang = "ja-JP";
            utterance.rate = 1.0;
            utterance.pitch = 1.2;
            utterance.volume = 1.0;
            speechSynthesis.speak(utterance);
          } catch (err) {
            const errorMsg = document.createElement("div");
            errorMsg.className = "message ai";
            errorMsg.textContent = "‚ö†Ô∏è ÂøúÁ≠î„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºö" + text;
            chatBox.appendChild(errorMsg);
          }

          statusBox.textContent = "";
          chatBox.scrollTop = chatBox.scrollHeight;
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusBox.textContent = "üé§ Èå≤Èü≥‰∏≠...";
      } catch (err) {
        alert("üé§ „Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÅÈå≤Èü≥„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇSafari„Åß„ÅØ„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        statusBox.textContent = "‚è≥ Âá¶ÁêÜ‰∏≠...";
      }
    };
  </script>
</body>
</html>
